package cmd

import (
	"bufio"
	"fmt"
	"os"
	"strings"

	"litemidgo/config"

	"github.com/spf13/cobra"
	"github.com/spf13/viper"
)

var configCmd = &cobra.Command{
	Use:   "config",
	Short: "Configure ServiceNow instance settings",
	Long: `Interactive configuration setup for ServiceNow instance connection.
This will guide you through setting up the required parameters.`,
	Run: func(cmd *cobra.Command, args []string) {
		runConfigSetup()
	},
}

var configTestCmd = &cobra.Command{
	Use:   "test",
	Short: "Test connection to configured ServiceNow instance",
	Long: `Test the connection to the configured ServiceNow instance to verify
that the credentials and network connectivity are working correctly.`,
	Run: func(cmd *cobra.Command, args []string) {
		testConnection()
	},
}

func init() {
	rootCmd.AddCommand(configCmd)
	configCmd.AddCommand(configTestCmd)
}

func runConfigSetup() {
	reader := bufio.NewReader(os.Stdin)
	
	fmt.Println("üîß LiteMIDgo Configuration Setup")
	fmt.Println("================================")
	fmt.Println()

	// Get ServiceNow instance
	instance := getInput(reader, "ServiceNow instance (e.g., your-instance.service-now.com):")
	
	// Get username
	username := getInput(reader, "ServiceNow username:")
	
	// Get password
	fmt.Print("ServiceNow password: ")
	password, _ := reader.ReadString('\n')
	password = strings.TrimSpace(password)
	
	// Get server host
	host := getInputWithDefault(reader, "Server host (default: 0.0.0.0):", "0.0.0.0")
	
	// Get server port
	portStr := getInputWithDefault(reader, "Server port (default: 8080):", "8080")
	
	// Get HTTPS preference
	httpsStr := getInputWithDefault(reader, "Use HTTPS? (y/n, default: y):", "y")
	useHTTPS := strings.ToLower(httpsStr) == "y" || strings.ToLower(httpsStr) == "yes"
	
	// Get timeout
	timeoutStr := getInputWithDefault(reader, "Timeout in seconds (default: 30):", "30")

	// Create config directory if it doesn't exist
	configDir := "./config"
	if _, err := os.Stat(configDir); os.IsNotExist(err) {
		os.Mkdir(configDir, 0755)
	}

	// Write configuration to file
	configFile := configDir + "/config.yaml"
	file, err := os.Create(configFile)
	if err != nil {
		fmt.Printf("‚ùå Failed to create config file: %v\n", err)
		return
	}
	defer file.Close()

	configContent := fmt.Sprintf(`server:
  host: "%s"
  port: %s

servicenow:
  instance: "%s"
  username: "%s"
  password: "%s"
  use_https: %t
  timeout: %s
`, host, portStr, instance, username, password, useHTTPS, timeoutStr)

	if _, err := file.WriteString(configContent); err != nil {
		fmt.Printf("‚ùå Failed to write config file: %v\n", err)
		return
	}

	fmt.Printf("‚úÖ Configuration saved to %s\n", configFile)
	fmt.Println()
	fmt.Println("You can now start the server with:")
	fmt.Println("  litemidgo server")
	fmt.Println()
	fmt.Println("Or test the connection with:")
	fmt.Println("  litemidgo config test")
}

func testConnection() {
	// Load configuration
	cfg, err := config.LoadConfig(cfgFile)
	if err != nil {
		fmt.Printf("‚ùå Failed to load configuration: %v\n", err)
		return
	}

	// Validate configuration
	if err := cfg.Validate(); err != nil {
		fmt.Printf("‚ùå Configuration validation failed: %v\n", err)
		return
	}

	fmt.Printf("üîç Testing connection to %s...\n", cfg.ServiceNow.Instance)

	// Create ServiceNow client and test connection
	snowClient := servicenow.NewClient(&cfg.ServiceNow)
	if err := snowClient.TestConnection(); err != nil {
		fmt.Printf("‚ùå Connection test failed: %v\n", err)
		return
	}

	fmt.Printf("‚úÖ Connection successful to %s\n", snowClient.GetInstanceURL())
}

func getInput(reader *bufio.Reader, prompt string) string {
	fmt.Print(prompt + " ")
	input, _ := reader.ReadString('\n')
	return strings.TrimSpace(input)
}

func getInputWithDefault(reader *bufio.Reader, prompt, defaultValue string) string {
	fmt.Print(prompt + " ")
	input, _ := reader.ReadString('\n')
	input = strings.TrimSpace(input)
	
	if input == "" {
		return defaultValue
	}
	return input
}
